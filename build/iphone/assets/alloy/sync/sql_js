var _=require('/alloy/underscore')._,backbone=require('/alloy/backbone'),ALLOY_DB_DEFAULT='_alloy_',ALLOY_ID_DEFAULT='alloy_id';function S4(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function guid(){return S4()+S4()+'-'+S4()+'-'+S4()+'-'+S4()+'-'+S4()+S4()+S4()}var cache={config:{},Model:{}};function Migrator(a,b){this.db=b,this.dbname=a.adapter.db_name,this.table=a.adapter.collection_name,this.idAttribute=a.adapter.idAttribute,this.column=function(a){var b=a.split(/\s+/),c=b[0];switch(c.toLowerCase()){case'string':case'varchar':case'date':case'datetime':Ti.API.warn('"'+c+'" is not a valid sqlite field, using TEXT instead');case'text':c='TEXT';break;case'int':case'tinyint':case'smallint':case'bigint':case'boolean':Ti.API.warn('"'+c+'" is not a valid sqlite field, using INTEGER instead');case'integer':c='INTEGER';break;case'double':case'float':case'decimal':case'number':Ti.API.warn('"'+a+'" is not a valid sqlite field, using REAL instead');case'real':c='REAL';break;case'blob':c='BLOB';break;case'null':c='NULL';break;default:c='TEXT';}return b[0]=c,b.join(' ')},this.createTable=function(a){var b=[],c=!1;for(var d in a.columns)d===this.idAttribute&&(c=!0),b.push(d+' '+this.column(a.columns[d]));c||this.idAttribute!==ALLOY_ID_DEFAULT||b.push(ALLOY_ID_DEFAULT+' TEXT UNIQUE');var e='CREATE TABLE IF NOT EXISTS '+this.table+' ( '+b.join(',')+')';this.db.execute(e)},this.dropTable=function(){this.db.execute('DROP TABLE IF EXISTS '+this.table)},this.insertRow=function(a){var b=[],c=[],d=[],e=!1;for(var f in a)f===this.idAttribute&&(e=!0),b.push(f),c.push(a[f]),d.push('?');e||this.idAttribute!==ALLOY_ID_DEFAULT||(b.push(this.idAttribute),c.push(guid()),d.push('?')),this.db.execute('INSERT INTO '+this.table+' ('+b.join(',')+') VALUES ('+d.join(',')+');',c)},this.deleteRow=function(a){var b='DELETE FROM '+this.table,c=_.keys(a),d=c.length,e=[],f=[];d&&(b+=' WHERE ');for(var g=0;g<d;g++)e.push(c[g]+' = ?'),f.push(a[c[g]]);b+=e.join(' AND '),this.db.execute(b,f)}}function Sync(a,b,c){var d,e,f=b.config.adapter.collection_name,g=b.config.columns,h=b.config.adapter.db_name||ALLOY_DB_DEFAULT,j=null;switch(a){case'create':case'update':j=function(){var a={};b.id||(b.id=b.idAttribute===ALLOY_ID_DEFAULT?guid():null,a[b.idAttribute]=b.id,'0.9.2'===backbone.VERSION?b.set(a,{silent:!0}):b.set(a));var c=[],i=[],j=[];for(var l in g)c.push(l),i.push(b.get(l)),j.push('?');return e='REPLACE INTO '+f+' ('+c.join(',')+') VALUES ('+j.join(',')+');',d=Ti.Database.open(h),d.execute(e,i),null===b.id&&(b.id=d.lastInsertRowId,a[b.idAttribute]=b.id,'0.9.2'===backbone.VERSION?b.set(a,{silent:!0}):b.set(a)),d.close(),b.toJSON()}();break;case'read':c.query&&c.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),e='SELECT * FROM '+f,c.query?e=c.query:c.id&&(e+=' WHERE '+(b.idAttribute?b.idAttribute:ALLOY_ID_DEFAULT)+' = '+(_.isString(c.id)?'"'+c.id+'"':c.id)),d=Ti.Database.open(h);var k=_.isString(e)?d.execute(e):d.execute(e.statement,e.params);for(var l=[],m=[],n=_.isFunction(k.fieldCount)?k.fieldCount():k.fieldCount,p=k.field,q=0;q<n;q++)m.push(k.fieldName(q));for(;k.isValidRow();){var i={};for(q=0;q<n;q++)i[m[q]]=p(q);l.push(i),k.next()}k.close(),d.close();var o=l.length;'0.9.2'===backbone.VERSION&&(b.length=o),j=1===o?l[0]:l;break;case'delete':e='DELETE FROM '+f+' WHERE '+b.idAttribute+'=?',d=Ti.Database.open(h),d.execute(e,b.id),d.close(),j=b.toJSON();}j?(_.isFunction(c.success)&&c.success(j),'read'===a&&!c.silent&&b.trigger('fetch',{fromAdapter:!0})):_.isFunction(c.error)&&c.error(j)}function GetMigrationFor(a,b){var c=null,d=Ti.Database.open(a);d.execute('CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);');var e=d.execute('SELECT latest FROM migrations where model = ?;',b);return e.isValidRow()&&(c=e.field(0)+''),e.close(),d.close(),c}function Migrate(a){var b=a.migrations||[],c={};b.length&&b[b.length-1](c);var d=a.prototype.config;d.adapter.db_name=d.adapter.db_name||ALLOY_DB_DEFAULT;var e=new Migrator(d),f='undefined'==typeof d.adapter.migration||null===d.adapter.migration?c.id:d.adapter.migration;if('undefined'==typeof f||null===f){var g=Ti.Database.open(d.adapter.db_name);return e.db=g,e.createTable(d),void g.close()}f+='';var h,j=GetMigrationFor(d.adapter.db_name,d.adapter.collection_name);if(j!==f){if(j&&j>f?(h=0,b.reverse()):h=1,db=Ti.Database.open(d.adapter.db_name),e.db=db,db.execute('BEGIN;'),b.length)for(var k=0;k<b.length;k++){var i=b[k],l={};if(i(l),h){if(l.id>f)break;if(l.id<=j)continue}else{if(l.id<=f)break;if(l.id>j)continue}var m=h?'up':'down';_.isFunction(l[m])&&l[m](e,d)}else e.createTable(d);db.execute('DELETE FROM migrations where model = ?',d.adapter.collection_name),db.execute('INSERT INTO migrations VALUES (?,?)',f,d.adapter.collection_name),db.execute('COMMIT;'),db.close(),e.db=null}}function installDatabase(a){var b=_.isFunction(a.adapter.db_file)?a.adapter.db_file(a):a.adapter.db_file,c=a.adapter.collection_name,d=/(^|.*\/)([^\/]+)\.[^\/]+$/,e=b.match(d);if(null===e)throw'Invalid sql database filename "'+b+'"';a.adapter.db_name=a.adapter.db_name||e[2];var f=a.adapter.db_name;Ti.API.debug('Installing sql database "'+b+'" with name "'+f+'"');var g=Ti.Database.install(b,f);!1!==a.adapter.remoteBackup||0||(Ti.API.debug('iCloud "do not backup" flag set for database "'+b+'"'),g.file.setRemoteBackup(!1));var h,i,j=g.execute('pragma table_info("'+c+'");'),l={};if(j){for(;j.isValidRow();)h=j.fieldByName('name'),i=j.fieldByName('type'),l[h]=i,h!==ALLOY_ID_DEFAULT||a.adapter.idAttribute||(a.adapter.idAttribute=ALLOY_ID_DEFAULT),j.next();j.close()}if(0===Object.keys(l).length){a.adapter.idAttribute?a.adapter.idAttribute:ALLOY_ID_DEFAULT;for(var m in a.columns)h=m,i=a.columns[m],h!==ALLOY_ID_DEFAULT||a.adapter.idAttribute?m===a.adapter.idAttribute&&(i+=' UNIQUE'):a.adapter.idAttribute=ALLOY_ID_DEFAULT,l[h]=i}if(a.columns=l,!a.adapter.idAttribute){Ti.API.info('No config.adapter.idAttribute specified for table "'+c+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var k=[],n=[];_.each(a.columns,function(a,b){n.push(b),k.push(b+' '+a)});var o=n.join(',');g.execute('ALTER TABLE '+c+' RENAME TO '+c+'_temp;'),g.execute('CREATE TABLE '+c+'('+k.join(',')+','+ALLOY_ID_DEFAULT+' TEXT UNIQUE);'),g.execute('INSERT INTO '+c+'('+o+','+ALLOY_ID_DEFAULT+') SELECT '+o+',CAST(_ROWID_ AS TEXT) FROM '+c+'_temp;'),g.execute('DROP TABLE '+c+'_temp;'),a.columns[ALLOY_ID_DEFAULT]='TEXT UNIQUE',a.adapter.idAttribute=ALLOY_ID_DEFAULT}else if(!_.contains(_.keys(a.columns),a.adapter.idAttribute))throw'config.adapter.idAttribute "'+a.adapter.idAttribute+'" not found in list of columns for table "'+c+'"\ncolumns: ['+_.keys(a.columns).join(',')+']';g.close()}module.exports.beforeModelCreate=function(a,b){if(cache.config[b])return cache.config[b];if('mobileweb'===Ti.Platform.osname||'undefined'==typeof Ti.Database)throw'No support for Titanium.Database in MobileWeb environment.';return a.adapter.db_file&&installDatabase(a),a.adapter.idAttribute||(Ti.API.info('No config.adapter.idAttribute specified for table "'+a.adapter.collection_name+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows'),a.columns[ALLOY_ID_DEFAULT]='TEXT UNIQUE',a.adapter.idAttribute=ALLOY_ID_DEFAULT),cache.config[b]=a,a},module.exports.afterModelCreate=function(a,b){return cache.Model[b]?cache.Model[b]:(a=a||{},a.prototype.idAttribute=a.prototype.config.adapter.idAttribute,Migrate(a),cache.Model[b]=a,a)},module.exports.sync=Sync;